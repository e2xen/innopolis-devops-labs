# Kube Prometheus Stack

## Components

- `Prometheus Operator`: a Kubernetes extension that delivers k8s-native experience with the deployment of Prometheus
- `Prometheus`: collects metrics from different places
- `Alertmanager`: handles alerts generated by Prometheus
- `Prometheus node-exporter`: gathers hardware metrics from k8s cluster nodes
- `Prometheus Adapter for Kubernetes Metrics APIs`: allows k8s to collect custom metrics from pods and use them in autoscaling decisions
- `kube-state-metrics`: collects metrics of k8s objects
- `Grafana`: visualization tool that shows collected metrics on dashboards

## Resources after charts installation

```shell
$kubectl get po,sts,svc,pvc,cm
NAME                                                         READY   STATUS    RESTARTS        AGE
pod/alertmanager-kube-prometheus-kube-prome-alertmanager-0   2/2     Running   1 (3m17s ago)   3m35s
pod/kube-prometheus-grafana-694d7c6c7f-hgg2b                 3/3     Running   0               3m48s
pod/kube-prometheus-kube-prome-operator-b48f94f57-xl56g      1/1     Running   0               3m48s
pod/kube-prometheus-kube-state-metrics-66b47fc45d-fq79m      1/1     Running   0               3m48s
pod/kube-prometheus-prometheus-node-exporter-78rkn           1/1     Running   0               3m48s
pod/prometheus-kube-prometheus-kube-prome-prometheus-0       2/2     Running   0               3m35s
pod/web-app-0                                                1/1     Running   0               60s
pod/web-app-1                                                1/1     Running   0               60s
pod/web-app-2                                                1/1     Running   0               60s

NAME                                                                    READY   AGE
statefulset.apps/alertmanager-kube-prometheus-kube-prome-alertmanager   1/1     3m35s
statefulset.apps/prometheus-kube-prometheus-kube-prome-prometheus       1/1     3m35s
statefulset.apps/web-app                                                3/3     60s

NAME                                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/alertmanager-operated                      ClusterIP   None             <none>        9093/TCP,9094/TCP,9094/UDP   3m35s
service/kube-prometheus-grafana                    ClusterIP   10.107.45.144    <none>        80/TCP                       3m48s
service/kube-prometheus-kube-prome-alertmanager    ClusterIP   10.102.82.212    <none>        9093/TCP                     3m48s
service/kube-prometheus-kube-prome-operator        ClusterIP   10.110.161.142   <none>        443/TCP                      3m48s
service/kube-prometheus-kube-prome-prometheus      ClusterIP   10.102.93.57     <none>        9090/TCP                     3m48s
service/kube-prometheus-kube-state-metrics         ClusterIP   10.100.91.128    <none>        8080/TCP                     3m48s
service/kube-prometheus-prometheus-node-exporter   ClusterIP   10.108.70.1      <none>        9100/TCP                     3m48s
service/kubernetes                                 ClusterIP   10.96.0.1        <none>        443/TCP                      13d
service/prometheus-operated                        ClusterIP   None             <none>        9090/TCP                     3m35s
service/web-app                                    ClusterIP   10.101.50.99     <none>        80/TCP                       60s

NAME                                                     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/persistent-data-volume-web-app-0   Bound    pvc-0e89812f-203e-4dc4-892b-897eab324d8f   100Mi      RWO            standard       60s
persistentvolumeclaim/persistent-data-volume-web-app-1   Bound    pvc-e8b72127-8a78-4207-98b8-422f687a1718   100Mi      RWO            standard       60s
persistentvolumeclaim/persistent-data-volume-web-app-2   Bound    pvc-fe74ef9b-312b-4e85-a124-ab4410b14027   100Mi      RWO            standard       60s

NAME                                                                     DATA   AGE
configmap/kube-prometheus-grafana                                        1      3m48s
configmap/kube-prometheus-grafana-config-dashboards                      1      3m48s
configmap/kube-prometheus-kube-prome-alertmanager-overview               1      3m48s
configmap/kube-prometheus-kube-prome-apiserver                           1      3m48s
configmap/kube-prometheus-kube-prome-cluster-total                       1      3m48s
configmap/kube-prometheus-kube-prome-controller-manager                  1      3m48s
configmap/kube-prometheus-kube-prome-etcd                                1      3m48s
configmap/kube-prometheus-kube-prome-grafana-datasource                  1      3m48s
configmap/kube-prometheus-kube-prome-grafana-overview                    1      3m48s
configmap/kube-prometheus-kube-prome-k8s-coredns                         1      3m48s
configmap/kube-prometheus-kube-prome-k8s-resources-cluster               1      3m48s
configmap/kube-prometheus-kube-prome-k8s-resources-namespace             1      3m48s
configmap/kube-prometheus-kube-prome-k8s-resources-node                  1      3m48s
configmap/kube-prometheus-kube-prome-k8s-resources-pod                   1      3m48s
configmap/kube-prometheus-kube-prome-k8s-resources-workload              1      3m48s
configmap/kube-prometheus-kube-prome-k8s-resources-workloads-namespace   1      3m48s
configmap/kube-prometheus-kube-prome-kubelet                             1      3m48s
configmap/kube-prometheus-kube-prome-namespace-by-pod                    1      3m48s
configmap/kube-prometheus-kube-prome-namespace-by-workload               1      3m48s
configmap/kube-prometheus-kube-prome-node-cluster-rsrc-use               1      3m48s
configmap/kube-prometheus-kube-prome-node-rsrc-use                       1      3m48s
configmap/kube-prometheus-kube-prome-nodes                               1      3m48s
configmap/kube-prometheus-kube-prome-nodes-darwin                        1      3m48s
configmap/kube-prometheus-kube-prome-persistentvolumesusage              1      3m48s
configmap/kube-prometheus-kube-prome-pod-total                           1      3m48s
configmap/kube-prometheus-kube-prome-prometheus                          1      3m48s
configmap/kube-prometheus-kube-prome-proxy                               1      3m48s
configmap/kube-prometheus-kube-prome-scheduler                           1      3m48s
configmap/kube-prometheus-kube-prome-workload-total                      1      3m48s
configmap/kube-root-ca.crt                                               1      41d
configmap/prometheus-kube-prometheus-kube-prome-prometheus-rulefiles-0   29     3m35s
configmap/web-app-config                                                 1      60s
```

The command shows the list of the following existing resources:
- pods
- stateful sets
- services
- persistent volumes
- config maps

## Metrics


i. Check how much CPU and Memory your StatefulSet is consuming

No data :(
![](https://i.imgur.com/6GYLwQi.png)

ii. Check which Pod is using CPU more than others and which is less in the default namespace

No data :(
![](https://i.imgur.com/uXDQJwG.png)

iii. Check how much memory is used on your node, in % and mb

62.5% and 2.3GiB
![](https://i.imgur.com/b0a40Ta.png)

iv. Check how many pods and containers actually ran by the Kubelet service

18 pods and 35 containers
![](https://i.imgur.com/0Sd4go0.png)

v. Check which Pod is using network more than others and which is less in the default namespace

No data :(
![](https://i.imgur.com/AoXQyHE.png)

vi. Check how many alerts you have

9 alerts
![](https://i.imgur.com/eh2IFrT.png)
![](https://i.imgur.com/tpdmfRE.png)


## Init container

```shell
$kubectl apply -f https://k8s.io/examples/pods/init-containers.yaml
pod/init-demo created

$kubectl get pod init-demo
NAME        READY   STATUS            RESTARTS   AGE
init-demo   0/1     PodInitializing   0          12s

$kubectl get pod init-demo
NAME        READY   STATUS    RESTARTS   AGE
init-demo   1/1     Running   0          26s

$kubectl exec pod/init-demo -- cat /usr/share/nginx/html/index.html
Defaulted container "nginx" out of: nginx, install (init)
<html><head></head><body><header>
<title>http://info.cern.ch</title>
</header>

<h1>http://info.cern.ch - home of the first website</h1>
<p>From here you can:</p>
<ul>
<li><a href="http://info.cern.ch/hypertext/WWW/TheProject.html">Browse the first website</a></li>
<li><a href="http://line-mode.cern.ch/www/hypertext/WWW/TheProject.html">Browse the first website using the line-mode browser simulator</a></li>
<li><a href="http://home.web.cern.ch/topics/birth-web">Learn about the birth of the web</a></li>
<li><a href="http://home.web.cern.ch/about">Learn about CERN, the physics laboratory where the web was born</a></li>
</ul>
</body></html>
```
